import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import {
  Container,
  Row,
  Col,
  Card,
  Button,
  Modal,
  Form,
  Table,
  Dropdown,
} from "react-bootstrap";
import {
  FaEdit,
  FaTrash,
  FaEye,
  FaPlus,
  FaSearch,
  FaUserTie,
  FaEllipsisV,
  FaFileAlt,
  FaIdCard
} from "react-icons/fa";
import { fetchHosts, fetchHostProperties, updateHostStatus } from "../../api";
import "bootstrap/dist/css/bootstrap.min.css";

const AdminHostsList = () => {
  const navigate = useNavigate();
  const [hosts, setHosts] = useState([]);
  const [filteredHosts, setFilteredHosts] = useState([]);
  const [searchTerm, setSearchTerm] = useState("");

  // Modals
  const [showEditModal, setShowEditModal] = useState(false);
  const [showAddModal, setShowAddModal] = useState(false);
  const [showDetailsModal, setShowDetailsModal] = useState(false);
  const [showDocsModal, setShowDocsModal] = useState(false);
  
  const [selectedHost, setSelectedHost] = useState(null);
  const [newHost, setNewHost] = useState({
    company: "",
    owner: "",
    phone: "",
    email: "",
  });

  // Load registered hosts from API on component mount
  useEffect(() => {
    loadHosts();
  }, []);

  useEffect(() => {
    if (searchTerm) {
        const filtered = hosts.filter(
            (host) =>
            host.company.toLowerCase().includes(searchTerm.toLowerCase()) ||
            host.owner.toLowerCase().includes(searchTerm.toLowerCase())
        );
        setFilteredHosts(filtered);
    } else {
        setFilteredHosts(hosts);
    }
  }, [searchTerm, hosts]);

  const loadHosts = async () => {
      try {
            const properties = await fetchHostProperties(host.id);
            return { hostId: host.id, count: properties.length };
          } catch (err) {
            console.error(`Error fetching properties for host ${host.id}:`, err);
            return { hostId: host.id, count: 0 };
          }
        });
        
        const propertyCounts = await Promise.all(propertyCountPromises);
        
        // Update hosts with property counts
        updatedHosts = updatedHosts.map((host) => {
          const countData = propertyCounts.find(pc => pc.hostId === host.id);
          return { ...host, properties: countData ? countData.count : 0 };
        });

        setHosts(updatedHosts);
        setFilteredHosts(updatedHosts);
      } catch (error) {
        console.error("Error loading hosts:", error);
        setHosts([]);
      }
    };

  const handleEdit = (host) => {
    setSelectedHost(host);
    setShowEditModal(true);
  };

  const handleDelete = (id) => {
    if (window.confirm("Are you sure you want to delete this host?")) {
      // Implement delete API call if needed
      setHosts(hosts.filter((h) => h.id !== id));
    }
  };

  const handleSaveEdit = () => {
    // Implement update API call
    setHosts(hosts.map((h) => (h.id === selectedHost.id ? selectedHost : h)));
    setShowEditModal(false);
  };

  const handleAddHost = () => {
    // Implement create API call
    const host = {
      ...newHost,
      id: hosts.length + 1,
      status: "Active",
      properties: 0,
    };
    setHosts([...hosts, host]);
    setNewHost({ company: "", owner: "", phone: "", email: "" });
    setShowAddModal(false);
  };

  const handleStatusChange = async (id, newStatus) => {
    try {
        await updateHostStatus(id, newStatus);
        setHosts(hosts.map((h) => (h.id === id ? { ...h, status: newStatus } : h)));
        alert(`Host and all properties marked as ${newStatus}`);
    } catch (error) {
        console.error("Error updating host status:", error);
        alert("Failed to update status");
    }
  };

  const handleShowDetails = (host) => {
      setSelectedHost(host);
      setShowDetailsModal(true);
  };

  const handleShowDocs = (host) => {
      setSelectedHost(host);
      setShowDocsModal(true);
  };

  return (
    <Container
      fluid
      className="py-4"
      style={{ backgroundColor: "#f8f9fa", minHeight: "100vh" }}
    >
      <Row className="mb-4">
        <Col>
          <h1
            className="text-center"
            style={{ color: "#482b1b", fontWeight: "700" }}
          >
            Hosts Management
          </h1>
          <p className="text-center text-muted">
            Manage all host companies and their properties
          </p>
        </Col>
      </Row>

      {/* Search Bar */}
      <Row className="mb-4 justify-content-center">
        <Col md={6}>
          <div className="input-group">
            <span className="input-group-text">
              <FaSearch />
            </span>
            <Form.Control
              type="text"
              placeholder="Search by company or owner..."
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="form-control-lg"
            />
          </div>
        </Col>
      </Row>

      {/* Hosts Table */}
      <Row>
        <Col>
          <Card className="shadow">
            <Card.Header className="d-flex justify-content-between align-items-center">
              <h4 className="mb-0">Host Companies</h4>
              <Button
                variant="primary"
                onClick={() => setShowAddModal(true)}
                style={{ backgroundColor: "#de5c06ff", border: "none" }}
              >
                <FaPlus className="me-2" /> Add New Host
              </Button>
            </Card.Header>
            <Card.Body>
              <Table responsive hover>
                <thead>
                  <tr>
                    <th>S.No</th>
                    <th>Company</th>
                    <th>Owner</th>
                    <th>Phone</th>
                    <th>Email</th>
                    <th>Status</th>
                    <th>Properties</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {filteredHosts.map((host, index) => (
                    <tr key={host.id}>
                          <option value="Inactive">Inactive</option>
                        </Form.Select>
                      </td>
                      <td>{host.properties}</td>
                      <td>
                        <div className="d-flex align-items-center">
                            <Button
                            variant="outline-primary"
                            size="sm"
                            className="me-2"
                            onClick={() => handleEdit(host)}
                            title="Edit"
                            >
                            <FaEdit />
                            </Button>
                            <Button
                            variant="outline-info"
                            size="sm"
                            className="me-2"
                            onClick={() =>
                                navigate("/admin/host-properties", {
                                state: { host },
                                })
                            }
                            title="View Properties"
                            >
                            <FaEye />
                            </Button>
                            
                            <Dropdown>
                                <Dropdown.Toggle variant="light" size="sm" id={`dropdown-${host.id}`}>
                                    <FaEllipsisV />
                                </Dropdown.Toggle>
                                <Dropdown.Menu>
                                    <Dropdown.Item onClick={() => handleShowDetails(host)}>
                                        <FaUserTie className="me-2" /> Registration Details
                                    </Dropdown.Item>
                                    <Dropdown.Item onClick={() => handleShowDocs(host)}>
                                        <FaFileAlt className="me-2" /> Documents
                                    </Dropdown.Item>
                                    <Dropdown.Item onClick={() => handleShowDocs(host)}>
                                        <FaIdCard className="me-2" /> Aadhaar
                                    </Dropdown.Item>
                                </Dropdown.Menu>
                            </Dropdown>
                        </div>
                      </td>
                    </tr>
                  ))}
                </tbody>
              </Table>
            </Card.Body>
          </Card>
        </Col>
      </Row>

      {/* Edit Host Modal */}
      <Modal show={showEditModal} onHide={() => setShowEditModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Edit Host</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          {selectedHost && (
            <Form>
              <Row>
                <Col md={6}>
                  <Form.Group className="mb-3">
                    <Form.Label>Company Name</Form.Label>
                    <Form.Control
                      type="text"
                      value={selectedHost.company}
                      onChange={(e) =>
                        setSelectedHost({
                          ...selectedHost,
                          company: e.target.value,
                        })
                      }
                    />
                  </Form.Group>
                </Col>
                <Col md={6}>
                  <Form.Group className="mb-3">
                    <Form.Label>Owner Name</Form.Label>
                    <Form.Control
                      type="text"
                      value={selectedHost.owner}
                      onChange={(e) =>
                        setSelectedHost({
                          ...selectedHost,
                          owner: e.target.value,
                        })
                      }
                    />
                  </Form.Group>
                </Col>
              </Row>
              <Row>
                <Col md={6}>
                  <Form.Group className="mb-3">
                    <Form.Label>Phone</Form.Label>
                    <Form.Control
                      type="text"
                      value={selectedHost.phone}
                      onChange={(e) =>
                        setSelectedHost({
                          ...selectedHost,
                          phone: e.target.value,
                        })
                      }
                    />
                  </Form.Group>
                </Col>
                <Col md={6}>
                  <Form.Group className="mb-3">
                    <Form.Label>Email</Form.Label>
                    <Form.Control
                      type="email"
                      value={selectedHost.email}
                      onChange={(e) =>
                        setSelectedHost({
                          ...selectedHost,
                          email: e.target.value,
                        })
                      }
                    />
                  </Form.Group>
                </Col>
              </Row>
            </Form>
          )}
        </Modal.Body>
        <Modal.Footer>
          <Button variant="secondary" onClick={() => setShowEditModal(false)}>
            Cancel
          </Button>
          <Button
            variant="primary"
            onClick={handleSaveEdit}
            style={{ backgroundColor: "#de5c06ff", border: "none" }}
          >
            Save Changes
          </Button>
        </Modal.Footer>
      </Modal>

      {/* Add Host Modal */}
      <Modal show={showAddModal} onHide={() => setShowAddModal(false)}>
        <Modal.Header closeButton>
          <Modal.Title>Add New Host</Modal.Title>
        </Modal.Header>
        <Modal.Body>
          <Form>
            <Row>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Company Name</Form.Label>
                  <Form.Control
                    type="text"
                    value={newHost.company}
                    onChange={(e) =>
                      setNewHost({ ...newHost, company: e.target.value })
                    }
                  />
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Owner Name</Form.Label>
                  <Form.Control
                    type="text"
                    value={newHost.owner}
                    onChange={(e) =>
                      setNewHost({ ...newHost, owner: e.target.value })
                    }
                  />
                </Form.Group>
              </Col>
            </Row>
            <Row>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Phone</Form.Label>
                  <Form.Control
                    type="text"
                    value={newHost.phone}
                    onChange={(e) =>
                      setNewHost({ ...newHost, phone: e.target.value })
                    }
                  />
                </Form.Group>
              </Col>
              <Col md={6}>
                <Form.Group className="mb-3">
                  <Form.Label>Email</Form.Label>
                  <Form.Control
                    type="email"
                    value={newHost.email}
                    onChange={(e) =>
                      setNewHost({ ...newHost, email: e.target.value })
                    }
                  />
                </Form.Group>
              </Col>
            </Row>
          </Form>
        </Modal.Body>
        <Modal.Footer>
          <Button variant="secondary" onClick={() => setShowAddModal(false)}>
            Cancel
          </Button>
          <Button
            variant="primary"
            onClick={handleAddHost}
            style={{ backgroundColor: "#de5c06ff", border: "none" }}
          >
            Add Host
          </Button>
        </Modal.Footer>
      </Modal>

      {/* Registration Details Modal */}
      <Modal show={showDetailsModal} onHide={() => setShowDetailsModal(false)}>
          <Modal.Header closeButton>
              <Modal.Title>Registration Details</Modal.Title>
          </Modal.Header>
          <Modal.Body>
              {selectedHost && (
                  <div>
                      <p><strong>Company:</strong> {selectedHost.company}</p>
                      <p><strong>Owner:</strong> {selectedHost.owner}</p>
                      <p><strong>Email:</strong> {selectedHost.email}</p>
                      <p><strong>Phone:</strong> {selectedHost.phone}</p>
                      <p><strong>Address:</strong> {selectedHost.businessAddress || "N/A"}</p>
                      <p><strong>Business Type:</strong> {selectedHost.businessType || "N/A"}</p>
                  </div>
              )}
          </Modal.Body>
      </Modal>

      {/* Documents Modal (Aadhaar, GST, PAN) */}
      <Modal show={showDocsModal} onHide={() => setShowDocsModal(false)}>
          <Modal.Header closeButton>
              <Modal.Title>Host Documents</Modal.Title>
          </Modal.Header>
          <Modal.Body>
              {selectedHost && (
                  <div>
                      <div className="mb-3">
                          <strong>Aadhaar Number:</strong>
                          <p className={selectedHost.aadhaarNumber ? "text-success" : "text-danger"}>
                              {selectedHost.aadhaarNumber || "Not Uploaded"}
                          </p>
                      </div>
                      <div className="mb-3">
                          <strong>GST Number:</strong>
                          <p>{selectedHost.gstNumber || "N/A"}</p>
                      </div>
                      <div className="mb-3">
                          <strong>PAN Number:</strong>
                          <p>{selectedHost.panNumber || "N/A"}</p>
                      </div>
                  </div>
              )}
          </Modal.Body>
      </Modal>

    </Container>
  );
};

export default AdminHostsList;
