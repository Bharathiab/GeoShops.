import React, { useState, useEffect } from "react";
import { useNavigate } from "react-router-dom";
import {
  Container,
  Row,
  Col,
  Card,
  Button,
  Modal,
  Form,
  Table,
} from "react-bootstrap";
import {
  FaPlus,
  FaEdit,
  FaTrash,
  FaEye,
  FaChartLine,
  FaUsers,
  FaBuilding,
  FaCalendarAlt,
  FaHotel,
  FaUserTie,
  FaHeartbeat,
  FaCut,
} from "react-icons/fa";
import {
  PieChart,
  Pie,
  Cell,
  ResponsiveContainer,
  Legend,
  Tooltip,
} from "recharts";
import HostNavbar from "../../components/host/HostNavbar";
import HostCreateProperty from "../../components/host/HostCreateProperty";
import HostSubscriptionDetails from "../../components/host/HostSubscriptionDetails";
import SubscriptionGate from "../../components/host/SubscriptionGate";
import { fetchHostProperties, fetchHostBookings } from "../../api";
import "bootstrap/dist/css/bootstrap.min.css";

const HostDashboard = () => {
  const navigate = useNavigate();
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [properties, setProperties] = useState([]);
  const [bookings, setBookings] = useState([]);

  // Load properties and bookings from API on component mount
  useEffect(() => {
    const loadData = async () => {
      const loginData = localStorage.getItem("hostLoginData");
      if (!loginData) {
        setProperties([]);
        setBookings([]);
        return;
      }

      const parsedLoginData = JSON.parse(loginData);
      const hostId = parsedLoginData.hostId;

      // Fetch properties independently
      try {
        const hostProperties = await fetchHostProperties(hostId);
        console.log('ðŸ” DEBUG: Fetched properties:', hostProperties);
        console.log('ðŸ” DEBUG: Properties length:', hostProperties?.length);
        console.log('ðŸ” DEBUG: First property:', hostProperties?.[0]);

        // Backend already returns camelCase, no mapping needed
        setProperties(hostProperties);
      } catch (error) {
        console.error("Error loading properties:", error);
        setProperties([]);
      }

      // Fetch bookings independently
      try {
        const hostBookings = await fetchHostBookings(hostId);
        const mappedBookings = hostBookings.map(b => ({
          ...b,
          userId: b.user_id,
          propertyId: b.department === 'Hotel' ? b.hotel_id :
            b.department === 'Salon' ? b.saloon_id :
              b.department === 'Hospital' ? b.hospital_id :
                b.department === 'Cab' ? b.cab_id : null,
          status: b.status || 'Pending'
        }));
        setBookings(mappedBookings);
      } catch (error) {
        console.error("Error loading bookings:", error);
        setBookings([]);
      }
    };

    loadData();
  }, []);

  const departments = [
    { name: "Hotel", icon: <FaHotel />, color: "#007bff" },
    { name: "Cab", icon: <FaUserTie />, color: "#28a745" },
    { name: "Hospital", icon: <FaHeartbeat />, color: "#6f42c1" },
    { name: "Salon", icon: <FaCut />, color: "#fd7e14" },
  ];

  const stats = [
    {
      title: "Total Properties",
      value: properties.length,
      icon: <FaBuilding />,
      color: "#28a745",
    },
    {
      title: "Active Properties",
      value: properties.filter((p) => p.status === "Active").length,
      icon: <FaEye />,
      color: "#007bff",
    },
    {
      title: "Total Bookings",
      value: bookings.length,
      icon: <FaCalendarAlt />,
      color: "#17a2b8",
    },
    {
      title: "Revenue",
      value: "â‚¹0",
      icon: <FaChartLine />,
      color: "#dc3545",
    },
  ];

  // Prepare data for pie chart - bookings by department
  const pieChartData = departments
    .map((dept) => {
      const deptBookings = bookings.filter((b) =>
        properties.some(
          (p) => p.id === b.propertyId && p.department === dept.name
        )
      );
      return {
        name: dept.name,
        value: deptBookings.length,
        color: dept.color,
      };
    })
    .filter((item) => item.value > 0); // Only show departments with bookings

  const COLORS = ["#007bff", "#28a745", "#6f42c1", "#fd7e14"];

  const handleDepartmentClick = (department) => {
    navigate("/host/properties", { state: { selectedDepartment: department } });
  };

  const handleCreateProperty = () => {
    setShowCreateModal(true);
  };

  const handleEdit = (id) => {
    alert(`Edit property ${id}`);
  };

  const handleDelete = (id) => {
    if (window.confirm("Are you sure you want to delete this property?")) {
      // TODO: Add API call to delete property from database
      const updatedProperties = properties.filter((p) => p.id !== id);
      setProperties(updatedProperties);
    }
  };

  const handleToggleStatus = (id) => {
    // TODO: Add API call to update property status in database
    const updatedProperties = properties.map((p) =>
      p.id === id
        ? { ...p, status: p.status === "Active" ? "Inactive" : "Active" }
        : p
    );
    setProperties(updatedProperties);
  };

  const handleCreatePropertySubmit = async (newProperty) => {
    try {
      // Property is already created via API in HostCreateProperty component
      // Just reload the data from API
      const loginData = localStorage.getItem("hostLoginData");
      if (loginData) {
        const parsedLoginData = JSON.parse(loginData);
        const hostId = parsedLoginData.hostId;

        const hostProperties = await fetchHostProperties(hostId);
        // Backend already returns camelCase, no mapping needed
        setProperties(hostProperties);
      }
      setShowCreateModal(false);
    } catch (error) {
      console.error("Error refreshing properties:", error);
      setShowCreateModal(false);
    }
  };

  return (
    <>
      {/* Host Navbar */}
      <HostNavbar />

      {/* Main Content with proper margin */}
      <SubscriptionGate>
        <div className="host-main-content">
          <Container
            fluid
            className="py-4"
          >
            <Row className="mb-4">
              <Col>
                <h1
                  className="text-center"
                  style={{ color: "#482b1b", fontWeight: "700" }}
                >
                  Host Dashboard
                </h1>
                <p className="text-center text-muted">
                  Manage your properties and bookings
                </p>
              </Col>
            </Row>

            {/* Stats Cards */}
            <Row className="mb-4">
              {stats.map((stat, index) => (
                <Col key={index} md={3} className="mb-3">
                  <Card
                    className="text-center shadow-sm h-100"
                    style={{
                      animation: `fadeInUp 0.5s ease-out ${index * 0.1}s both`,
                    }}
                  >
                    <Card.Body>
                      <div
                        style={{
                          color: stat.color,
                          fontSize: "2rem",
                          marginBottom: "10px",
                        }}
                      >
                        {stat.icon}
                      </div>
                      <h3 className="mb-1">{stat.value}</h3>
                      <p className="text-muted mb-0">{stat.title}</p>
                    </Card.Body>
                  </Card>
                </Col>
              ))}
            </Row>

            {/* Subscription Details */}
            <Row className="mb-4">
              <Col>
                <HostSubscriptionDetails />
              </Col>
            </Row>

            {/* Pie Chart and Department Cards Row */}
            <Row className="mb-4">
              {/* Pie Chart */}
              <Col md={6} className="mb-4">
                <Card className="shadow h-100">
                  <Card.Header>
                    <h4 className="mb-0">Bookings by Department</h4>
                  </Card.Header>
                  <Card.Body>
                    {pieChartData.length > 0 ? (
                      <ResponsiveContainer width="100%" height={300}>
                        <PieChart>
                          <Pie
                            data={pieChartData}
                            cx="50%"
                            cy="50%"
                            labelLine={false}
                            label={({ name, percent }) =>
                              `${name} ${(percent * 100).toFixed(0)}%`
                            }
                            outerRadius={80}
                            fill="#8884d8"
                            dataKey="value"
                          >
                            {pieChartData.map((entry, index) => (
                              <Cell key={`cell-${index}`} fill={entry.color} />
                            ))}
                          </Pie>
                          <Tooltip
                            formatter={(value) => [`${value} bookings`, "Bookings"]}
                          />
                          <Legend />
                        </PieChart>
                      </ResponsiveContainer>
                    ) : (
                      <div className="text-center text-muted py-4">
                        <FaChartLine size={48} className="mb-3" />
                        <p>No booking data available</p>
                      </div>
                    )}
                  </Card.Body>
                </Card>
              </Col>

              {/* Department Selection Cards */}
              <Col md={6}>
                <h5 className="mb-3">Departments</h5>
                <Row>
                  {departments.map((dept, index) => {
                    const deptProperties = properties.filter(
                      (p) => p.department === dept.name
                    );
                    const deptBookings = bookings.filter((b) =>
                      properties.some(
                        (p) => p.id === b.propertyId && p.department === dept.name
                      )
                    );
                    return (
                      <Col key={dept.name} md={6} className="mb-3">
                        <Card
                          className="text-center shadow-sm h-100"
                          onClick={() => handleDepartmentClick(dept.name)}
                          style={{
                            cursor: "pointer",
                            transition: "all 0.3s ease",
                            animation: `fadeInUp 0.5s ease-out ${index * 0.1
                              }s both`,
                          }}
                        >
                          <Card.Body>
                            <div
                              style={{
                                color: dept.color,
                                fontSize: "2rem",
                                marginBottom: "10px",
                              }}
                            >
                              {dept.icon}
                            </div>
                            <h6>{dept.name}</h6>
                            <small className="text-muted">
                              {deptProperties.length} properties
                            </small>
                            <br />
                            <small className="text-primary">
                              {deptBookings.length} bookings
                            </small>
                          </Card.Body>
                        </Card>
                      </Col>
                    );
                  })}
                </Row>
              </Col>
            </Row>

            {/* Actions */}
            <Row className="mb-4">
              <Col className="text-end">
                <Button
                  variant="primary"
                  onClick={handleCreateProperty}
                  style={{ backgroundColor: "#de5c06ff", border: "none" }}
                >
                  <FaPlus className="me-2" /> Add New Property
                </Button>
              </Col>
            </Row>

            {/* Create Property Modal */}
            <Modal
              show={showCreateModal}
              onHide={() => setShowCreateModal(false)}
              size="lg"
            >
              <Modal.Header closeButton>
                <Modal.Title>Add New Property</Modal.Title>
              </Modal.Header>
              <Modal.Body>
                <HostCreateProperty onSubmit={handleCreatePropertySubmit} />
              </Modal.Body>
              <Modal.Footer>
                <Button
                  variant="secondary"
                  onClick={() => setShowCreateModal(false)}
                >
                  Cancel
                </Button>
              </Modal.Footer>
            </Modal>

            <style jsx>{`
          @keyframes fadeInUp {
            from {
              opacity: 0;
              transform: translateY(30px);
            }
            to {

      {/* Main Content with proper margin */}
      <SubscriptionGate>
        <div className="host-main-content">
          <Container
            fluid
            className="py-4"
          >
            <Row className="mb-4">
              <Col>
                <h1
                  className="text-center"
                  style={{ color: "#482b1b", fontWeight: "700" }}
                >
                  Host Dashboard
                </h1>
                <p className="text-center text-muted">
                  Manage your properties and bookings
                </p>
              </Col>
            </Row>

            {/* Stats Cards */}
            <Row className="mb-4">
              {stats.map((stat, index) => (
                <Col key={index} md={3} className="mb-3">
                  <Card
                    className="text-center shadow-sm h-100"
                    style={{
                      animation: `fadeInUp 0.5s ease-out ${index * 0.1}s both`,
                    }}
                  >
              <Card.Body>
                <div
                  style={{
                    color: stat.color,
                    fontSize: "2rem",
                    marginBottom: "10px",
                  }}
                >
                  {stat.icon}
                </div>
                <h3 className="mb-1">{stat.value}</h3>
                <p className="text-muted mb-0">{stat.title}</p>
              </Card.Body>
            </Card>
          </Col>
              ))}
        </Row>

        {/* Subscription Details */}
        <Row className="mb-4">
          <Col>
            <HostSubscriptionDetails />
          </Col>
        </Row>

        {/* Pie Chart and Department Cards Row */}
        <Row className="mb-4">
          {/* Pie Chart */}
          <Col md={6} className="mb-4">
            <Card className="shadow h-100">
              <Card.Header>
                <h4 className="mb-0">Bookings by Department</h4>
              </Card.Header>
              <Card.Body>
                {pieChartData.length > 0 ? (
                  <ResponsiveContainer width="100%" height={300}>
                    <PieChart>
                      <Pie
                        data={pieChartData}
                        cx="50%"
                        cy="50%"
                        labelLine={false}
                        label={({ name, percent }) =>
                          `${name} ${(percent * 100).toFixed(0)}%`
                        }
                        outerRadius={80}
                        fill="#8884d8"
                        dataKey="value"
                      >
                        {pieChartData.map((entry, index) => (
                          <Cell key={`cell-${index}`} fill={entry.color} />
                        ))}
                      </Pie>
                      <Tooltip
                        formatter={(value) => [`${value} bookings`, "Bookings"]}
                      />
                      <Legend />
                    </PieChart>
                  </ResponsiveContainer>
                ) : (
                  <div className="text-center text-muted py-4">
                    <FaChartLine size={48} className="mb-3" />
                    <p>No booking data available</p>
                  </div>
                )}
              </Card.Body>
            </Card>
          </Col>

          {/* Department Selection Cards */}
          <Col md={6}>
            <h5 className="mb-3">Departments</h5>
            <Row>
              {departments.map((dept, index) => {
                const deptProperties = properties.filter(
                  (p) => p.department === dept.name
                );
                const deptBookings = bookings.filter((b) =>
                  properties.some(
                    (p) => p.id === b.propertyId && p.department === dept.name
                  )
                );
                return (
                  <Col key={dept.name} md={6} className="mb-3">
                    <Card
                      className="text-center shadow-sm h-100"
                      onClick={() => handleDepartmentClick(dept.name)}
                      style={{
                        cursor: "pointer",
                        transition: "all 0.3s ease",
                        animation: `fadeInUp 0.5s ease-out ${index * 0.1
                          }s both`,
                      }}
                    >
                      <Card.Body>
                        <div
                          style={{
                            color: dept.color,
                            fontSize: "2rem",
                            marginBottom: "10px",
                          }}
                        >
                          {dept.icon}
                        </div>
                        <h6>{dept.name}</h6>
                        <small className="text-muted">
                          {deptProperties.length} properties
                        </small>
                        <br />
                        <small className="text-primary">
                          {deptBookings.length} bookings
                        </small>
                      </Card.Body>
                    </Card>
                  </Col>
                );
              })}
            </Row>
          </Col>
        </Row>

        {/* Actions */}
        <Row className="mb-4">
          <Col className="text-end">
            <Button
              variant="primary"
              onClick={handleCreateProperty}
              style={{ backgroundColor: "#de5c06ff", border: "none" }}
            >
              <FaPlus className="me-2" /> Add New Property
            </Button>
          </Col>
        </Row>

        {/* Create Property Modal */}
        <Modal
          show={showCreateModal}
          onHide={() => setShowCreateModal(false)}
          size="lg"
        >
          <Modal.Header closeButton>
            <Modal.Title>Add New Property</Modal.Title>
          </Modal.Header>
          <Modal.Body>
            <HostCreateProperty onSubmit={handleCreatePropertySubmit} />
          </Modal.Body>
          <Modal.Footer>
            <Button
              variant="secondary"
              onClick={() => setShowCreateModal(false)}
            >
              Cancel
            </Button>
          </Modal.Footer>
        </Modal>

        <style jsx>{`
          @keyframes fadeInUp {
            from {
              opacity: 0;
              transform: translateY(30px);
            }
            to {
              opacity: 1;
              transform: translateY(0);
            }
          }
        `}</style>
      </Container>
    </div >
      </SubscriptionGate >
    </>
      );
};

export default HostDashboard;
